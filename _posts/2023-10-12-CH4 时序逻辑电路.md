---
layout: post
title: CH4 时序逻辑电路
categories: LectureNotes
tags: [数字逻辑与计算机组成]
---

## 时序逻辑电路概述

时序逻辑：输出结果不仅取决于当前时刻的输入值，而且取决于电路过去时刻的行为（当前状态、现态、旧状态）。

* 电路中有**存储元件**，用于存储逻辑信号的值，表示电路过去时刻的行为（当前状态、现态、旧状态） 

* **当电路输入值发生变化时，新的输入值可能使得电路保持当前状态，也可能使得电路状态发生改变，进入新的状态**

  （理解这一点非常重要！有助于从硬件层面理解为什么时序逻辑电路能够存储状态）

### 有限状态机

有限状态机（Finite State Machine，FSM）是一种**刻画状态以及状态转换**的理论工具。

状态图来描述：

![image-20231011163836501](https://repo-for-md.oss-cn-beijing.aliyuncs.com/uPic/image-20231011163836501.png)

主要注意两点：状态、状态转换

可以用数字逻辑实现一个有限状态机：

* 将状态进行二进制编码（输入，输出，内部状态）
* 设计状态记忆电路（存储元件）
* 设计状态记忆电路的激励函数（根据当前输入把旧状态改为新状态的函数）和输出函数（根据旧状态和当前输入来改变电路输出结果的函数），并完成定时分析。

能够实现有限状态机的数字逻辑电路一定是时序逻辑电路。

### 时序逻辑电路基本结构

一般结构：

* 状态记忆模块：由多个状态记忆单元构成（存储元件）
* 次态激励逻辑模块F ：激励函数（现态和外部输入的逻辑函数）
* 输出逻辑模块G ：输出函数（现态和外部输入的逻辑函数）
  * Mealy型输出逻辑模块：输出依赖于当前状态和当前输入信号。
  * Moore型输出逻辑模块：输出**仅依赖于当前状态（考虑了当前输入对当前状态的更新）**，和当前输入信号无关。

（像不像LSTM？）

此外，时序逻辑电路还可能由时钟控制。实际上，根据**状态转换方式**的不同，时序逻辑电路还可以分为：

* 同步时序逻辑电路：在统一的时钟信号控制下进行状态转换
* 异步时序逻辑电路：没有统一的时钟信号来控制状态的改变

二者区别在于有没有统一的Clk（固定周期的标准脉冲信号）进行控制。下图是有Clk控制的：

![image-20231011213343973](https://repo-for-md.oss-cn-beijing.aliyuncs.com/uPic/image-20231011213343973.png)

### 时序逻辑电路的定时

时序逻辑电路的工作节律通过外部输入的时钟信号进行控制。**时钟信号Clk用于触发状态转换。**

每个时钟周期由高低电平两部分组成。时钟从低电平向高电平过渡称为**上升沿**，从高电平向低电平过渡称为**下降沿**。

状态转换通常采用**时钟边沿触发方式**（**上升沿触发/下降沿触发）**，也就是在半个时钟周期结束时的上升沿/下降沿是有效的触发信号（改变记忆单元状态）。

记忆单元状态的改变，会触发输出信号的改变，同时反馈到激励逻辑模块中，和当前输入信号一起生成新的激励信号，并等待下一个时钟触发边沿的到来。

也就是说，每半个时钟周期，电路状态才可能发生改变。

## 锁存器和触发器

时序逻辑电路具有内部状态的记忆元件，这种记忆功能可用专门硬件实现（如基于**双稳态元件**的各种锁存器和触发器等）。

根据状态改变方式的不同，双稳态电路分为**锁存器（latch）**和**触发器（flip-flop）**两种。

* 锁存器采用电平控制方式。在其控制信号的有效电平期间，外部输入信号的变化**一直能**触发其状态发生改变。
* 触发器采用时钟边沿触发控制方式。其只在**时钟信号的上升沿或下降沿达到以后**发生状态改变。

### 双稳态元件

用于存储**1位二进制数据（1 bit）**。

**只关注Q，它有两个互补的输出状态：**

* 状态 1 ：置位(Set)状态，表示存储逻辑“1” 
* 状态 0 ：复位(Reset)状态，表示存储逻辑“0”

![image-20231011224736317](https://repo-for-md.oss-cn-beijing.aliyuncs.com/uPic/image-20231011224736317.png)



关注红色部分，那么Vin1=0，Vin2=1，输出Vout1=1，Vout2=0，这是一个稳态。

用1个或多个输入信号能驱动双稳态元件进入稳定状态，这   些输入信号称为**激励信号或激励输入**。 

通常根据不同的激励输入信号来命名存储元件，如SR、JK、D、T 等不同的激励输入信号。

从上面的例子还是比较难以直观理解状态的储存（毕竟好像还是只是一个输入对应一个输出），下面的SR锁存器是一个更好的说明。

### SR锁存器

SR锁存器（置位复位锁存器，Set-Reset latch）：使用一对交叉耦合的或非门构成双稳态电路，也称为置位-重置（复位）锁存器。S是置位输入端，R是重置输入端。

![image-20231012104527936](https://repo-for-md.oss-cn-beijing.aliyuncs.com/uPic/image-20231012104527936.png)

它具有置位和复位激励信号：

* 置位激励信号Set有效时，强制存储元件的输出Q为1
* 复位激励信号Reset有效时，强制存储元件的输出Q为0

![image-20231012104825200](https://repo-for-md.oss-cn-beijing.aliyuncs.com/uPic/image-20231012104825200.png)

我们可以用状态图来描述这个有限状态机：

![image-20231012105119913](https://repo-for-md.oss-cn-beijing.aliyuncs.com/uPic/image-20231012105119913.png)

从输入驱动信号有效开始，到输出达到稳定为止有一定的延迟，这个延迟称为**触发延迟或锁存延迟**。

这里我们要引入两个新概念：

* 状态转移表：以输入信号和现态Q作为输入，与次态（输出）Q*的状态表

  ![image-20231012105426942](https://repo-for-md.oss-cn-beijing.aliyuncs.com/uPic/image-20231012105426942.png)

* 特征方程：用方程和输入约束条件的形式给出了状态转移表。

  ![image-20231012105554939](https://repo-for-md.oss-cn-beijing.aliyuncs.com/uPic/image-20231012105554939.png)

#### 功能：SR锁存器只有状态，没有输出，常用来设置标志位（什么意思？）

### D锁存器

D锁存器有一个状态驱动信号D，一个控制电路锁存信息的使能信号C。也称为透明锁存器。

当C为1时，闸门打开，输出Q等于D。当C转换为0，闸门关闭，输出Q停留在上一状态。

![image-20231012110525448](https://repo-for-md.oss-cn-beijing.aliyuncs.com/uPic/image-20231012110525448.png)

状态表、状态图、特征方程

![image-20231012110611664](https://repo-for-md.oss-cn-beijing.aliyuncs.com/uPic/image-20231012110611664.png)

时序图

![image-20231012110630399](https://repo-for-md.oss-cn-beijing.aliyuncs.com/uPic/image-20231012110630399.png)

有锁存延迟。

### D触发器

前面说到，触发器多采用时钟边沿触发机制。D触发器即这样的一种触发器。

经典的D触发器采用**一对主从D锁存器**构建。

D触发器结构示意图：

![image-20231012113249937](https://repo-for-md.oss-cn-beijing.aliyuncs.com/uPic/image-20231012113249937.png)

**上图是上升沿触发的D触发器示意图**

原理的理解：

* 主、从D锁存器从Clk接收到的信号相反。
* 只有接受到Clk信号为高电平才能传导信号。
* 以上性质决定了：主、从信号只有一个是通的。那么看看工作流程：
  * Clk在低电平时主锁存器通，从锁存器阻断，信号D能传导到$Q_{middle}$，也就是主、从锁存器中间。
  * 当Clk由低变高，主锁存器阻断（这没有关系，因为信号已经保存了），从锁存器通，然后原来储存在$Q_{middle}$（主锁存器输出）的信号能够通过从锁存器，更新输出。
  * 当Clk由高变低，主锁存器通，从锁存器断。那么输出不会改变，可能会改变的是$Q_{middle}$（与D相同）。

理解了上述原理以后，我们应该能理解下面这句话：

**D触发器的输入端D在时钟触发边沿到来时被采样。**

总的来说，D触发器通过两级闸门的切换来实现了利用时钟信号的控制。

当然，由于逻辑门延迟的存在，我们还需要确保一些事情：

* 建立时间（setup time）：在时钟触发边沿到来之前输入端D**必须保持稳定的最短时间**。
  * 这是因为输入端D的信号通过主锁存器传递到$Q_{middle}$需要一定时间。
* 保持时间（hold time）：在时钟触发边沿到来之后输入端D必须保持不变的最短时间。
  * Clk通过逻辑门传递到主锁存器有延迟。
  * 主锁存器的状态锁定需要转换时间。
* 锁存延迟（latch prop，Clk-to-Q）：从时钟触发边沿到来后到Q变为D的输入值的时间。
  * 包含了保持时间，以及信号通过从锁存器传递到Q的延迟时间。

![image-20231012114746127](https://repo-for-md.oss-cn-beijing.aliyuncs.com/uPic/image-20231012114746127.png)

D触发器的实现方式还有很多种，例如：

#### 带使能端的D触发器

通过使能端EN信号来控制是否在时钟信号的触发边沿进行数据的存储。

**其实就是朴素地加了一个对Clk的通断控制器。**

![image-20231012114921835](https://repo-for-md.oss-cn-beijing.aliyuncs.com/uPic/image-20231012114921835.png)

#### 带复位功能的D触发器

带复位功能的触发器电路中有一个复位信号Rst，通常有两种方式：

* 同步复位触发器：只能在Clk触发边沿进行复位
* 异步复位触发器：只要Rst有效就能进行复位

异步复位触发器可以考虑将Q和Rst作为与门输入。

同步复位触发器则将D和Rst作为与门输入。我们用$\bar{Rst}$代表当$\bar{Rst}$为低电平时，电路复位。

### T触发器

T触发器基于D触发器实现，可用于实现计数器、分频器等功能。

**T触发器没有显式输入。**（目前来看）只能实现频率转换的功能。

![在这里插入图片描述](https://repo-for-md.oss-cn-beijing.aliyuncs.com/uPic/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODQ0NjE4,size_16,color_FFFFFF,t_70.png)

![image-20231012120334974](https://repo-for-md.oss-cn-beijing.aliyuncs.com/uPic/image-20231012120334974.png)

可以看出T触发器将Clk频率降了一倍作为输出。（每个时钟周期变化一次）